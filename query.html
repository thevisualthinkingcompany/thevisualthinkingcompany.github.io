<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Query | Random Location</title>
  <meta name="description" content="4 Query | Random Location" />
  <meta name="generator" content="bookdown 0.37 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Query | Random Location" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Query | Random Location" />
  
  
  

<meta name="author" content="Your Name" />


<meta name="date" content="2025-01-28" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="sql-prep.html"/>
<link rel="next" href="leaflet-example.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="polygons-imports.html"><a href="polygons-imports.html"><i class="fa fa-check"></i><b>2</b> Polygons Imports</a></li>
<li class="chapter" data-level="3" data-path="sql-prep.html"><a href="sql-prep.html"><i class="fa fa-check"></i><b>3</b> SQL Prep</a>
<ul>
<li class="chapter" data-level="3.0.1" data-path="sql-prep.html"><a href="sql-prep.html#bounder"><i class="fa fa-check"></i><b>3.0.1</b> Bounder</a></li>
<li class="chapter" data-level="3.1" data-path="sql-prep.html"><a href="sql-prep.html#wkt-geometry"><i class="fa fa-check"></i><b>3.1</b> WKT geometry</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="query.html"><a href="query.html"><i class="fa fa-check"></i><b>4</b> Query</a>
<ul>
<li class="chapter" data-level="4.0.1" data-path="query.html"><a href="query.html#leaflet-bounding-box-view-box-filters"><i class="fa fa-check"></i><b>4.0.1</b> Leaflet Bounding Box (View Box) Filters</a></li>
<li class="chapter" data-level="4.0.2" data-path="query.html"><a href="query.html#engulfing-filter"><i class="fa fa-check"></i><b>4.0.2</b> Engulfing Filter</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="leaflet-example.html"><a href="leaflet-example.html"><i class="fa fa-check"></i><b>5</b> Leaflet Example</a></li>
<li class="chapter" data-level="6" data-path="set-up.html"><a href="set-up.html"><i class="fa fa-check"></i><b>6</b> Set Up</a></li>
<li class="chapter" data-level="7" data-path="example.html"><a href="example.html"><i class="fa fa-check"></i><b>7</b> Example</a>
<ul>
<li class="chapter" data-level="7.1" data-path="example.html"><a href="example.html#satellite"><i class="fa fa-check"></i><b>7.1</b> Satellite</a></li>
<li class="chapter" data-level="7.2" data-path="example.html"><a href="example.html#street"><i class="fa fa-check"></i><b>7.2</b> Street</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Random Location</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="query" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">4</span> Query<a href="query.html#query" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="leaflet-bounding-box-view-box-filters" class="section level3 hasAnchor" number="4.0.1">
<h3><span class="header-section-number">4.0.1</span> Leaflet Bounding Box (View Box) Filters<a href="query.html#leaflet-bounding-box-view-box-filters" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="filters" class="section level4 hasAnchor" number="4.0.1.1">
<h4><span class="header-section-number">4.0.1.1</span> Filters<a href="query.html#filters" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Generate a where clause based on bounding lines.</p>
<ul>
<li><p>Greedy finds a polygons that are partially OR wholly within the bounding box. The query north bound is above the polygon’s south bound and the query south bound is below the polygons north bound: This is only false if the polygon’s bounding box is entirely above or below the query bounding box.</p></li>
<li><p>Shy finds polygons that are ONLY wholly within the bounding box. The query north bound is above the polygon’s north bound and the query south bound is below the polygon’s south bound: This is false even if the bounding boxes overlap; it is only true when all corners of the polygon’s bounding box are within the corners of the query bounding box.</p>
<ul>
<li>^This may leave some empty spaces at the edges of the map frame, or, rarely, large missed polygons with odd, long juts. The problem is minimal when the map zoom is relatively far out compared to the average polygon size; in such a case, you’d likely be loading many polygons so the relatively small missed-polygons are a worthwhile cost for speed/data costs. The problem is pronounced when you’re very zoomed in; at the extreme, if you zoom in entirely on a polygon or on the border of two polygons, both of them would be filtered out!</li>
<li>Therefore, greedy should be used when zooms are relatively low, and shy should be used when zooms are relatively high. Central is a happy medium. <strong>See Dynamic Filter</strong> for a way to adjust display polygons in shiny to the zoom level.</li>
</ul></li>
<li><p>Central finds polygons with a centre point within the bounding frame. This will grab everything that Shy grabs (if all four corners are within the bounding frame, of course the centre is as well) and has the potential to grab some polygons which Shy will not (especially large polygons, or ones with odd, long juts which may be largely within the bounding frame with some corner outside for whatever reason). In cases where only a small portion of the polygon would be in frame, it will still load slightly fewer polygons than Greedy.</p></li>
<li><p>Point uses the central filter on our standard point data columns, to avoid confusion / avoid a duplicate function</p></li>
</ul>
<p>All these filter_types have four WHERE conditions so are not faster in terms of query searching, but Shy is faster than Central and Central is faster than Greedy in terms of downloading and mapping/loading that queried data (in so far as they return TRUE for fewer polygons).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="query.html#cb4-1" tabindex="-1"></a>bbox_filter <span class="ot">&lt;-</span> <span class="cf">function</span>(lat_min, lat_max, lng_min, lng_max, <span class="at">filter_type =</span> <span class="st">&quot;greedy&quot;</span>) {</span>
<span id="cb4-2"><a href="query.html#cb4-2" tabindex="-1"></a>  <span class="cf">if</span> (filter_type <span class="sc">==</span> <span class="st">&quot;greedy&quot;</span>) {</span>
<span id="cb4-3"><a href="query.html#cb4-3" tabindex="-1"></a>    where_clause <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(</span>
<span id="cb4-4"><a href="query.html#cb4-4" tabindex="-1"></a>      <span class="st">&quot;WHERE Bound_North &gt; %f AND Bound_South &lt; %f AND Bound_East &gt; %f AND Bound_West &lt; %f&quot;</span>,</span>
<span id="cb4-5"><a href="query.html#cb4-5" tabindex="-1"></a>      lat_min, lat_max, lng_min, lng_max</span>
<span id="cb4-6"><a href="query.html#cb4-6" tabindex="-1"></a>    )</span>
<span id="cb4-7"><a href="query.html#cb4-7" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (filter_type <span class="sc">==</span> <span class="st">&quot;shy&quot;</span>) {</span>
<span id="cb4-8"><a href="query.html#cb4-8" tabindex="-1"></a>    where_clause <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(</span>
<span id="cb4-9"><a href="query.html#cb4-9" tabindex="-1"></a>      <span class="st">&quot;WHERE Bound_North &lt;= %f AND Bound_South &gt;= %f AND Bound_East &lt;= %f AND Bound_West &gt;= %f&quot;</span>,</span>
<span id="cb4-10"><a href="query.html#cb4-10" tabindex="-1"></a>      lat_max, lat_min, lng_max, lng_min</span>
<span id="cb4-11"><a href="query.html#cb4-11" tabindex="-1"></a>    )</span>
<span id="cb4-12"><a href="query.html#cb4-12" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (filter_type <span class="sc">==</span> <span class="st">&quot;central&quot;</span>) {</span>
<span id="cb4-13"><a href="query.html#cb4-13" tabindex="-1"></a>    where_clause <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(</span>
<span id="cb4-14"><a href="query.html#cb4-14" tabindex="-1"></a>      <span class="st">&quot;WHERE Centre_Lat &gt;= %f AND Centre_Lat &lt;= %f AND Centre_Lng &gt;= %f AND Centre_Lng &lt;= %f&quot;</span>,</span>
<span id="cb4-15"><a href="query.html#cb4-15" tabindex="-1"></a>      lat_min, lat_max, lng_min, lng_max</span>
<span id="cb4-16"><a href="query.html#cb4-16" tabindex="-1"></a>    )</span>
<span id="cb4-17"><a href="query.html#cb4-17" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (filter_type <span class="sc">==</span> <span class="st">&quot;point&quot;</span>) {</span>
<span id="cb4-18"><a href="query.html#cb4-18" tabindex="-1"></a>    where_clause <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(</span>
<span id="cb4-19"><a href="query.html#cb4-19" tabindex="-1"></a>      <span class="st">&quot;WHERE lat &gt;= %f AND lat &lt;= %f AND lng &gt;= %f AND lng &lt;= %f&quot;</span>,</span>
<span id="cb4-20"><a href="query.html#cb4-20" tabindex="-1"></a>      lat_min, lat_max, lng_min, lng_max</span>
<span id="cb4-21"><a href="query.html#cb4-21" tabindex="-1"></a>    )</span>
<span id="cb4-22"><a href="query.html#cb4-22" tabindex="-1"></a>  }<span class="cf">else</span> {</span>
<span id="cb4-23"><a href="query.html#cb4-23" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Invalid filter_type specified.&quot;</span>)</span>
<span id="cb4-24"><a href="query.html#cb4-24" tabindex="-1"></a>  }</span>
<span id="cb4-25"><a href="query.html#cb4-25" tabindex="-1"></a>  </span>
<span id="cb4-26"><a href="query.html#cb4-26" tabindex="-1"></a>  <span class="fu">return</span>(where_clause)</span>
<span id="cb4-27"><a href="query.html#cb4-27" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="shiny-example" class="section level4 hasAnchor" number="4.0.1.2">
<h4><span class="header-section-number">4.0.1.2</span> Shiny Example<a href="query.html#shiny-example" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Example of live updating polygon layer in a shiny app, where a map has been created as mapname &lt;- leaflet()…</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="query.html#cb5-1" tabindex="-1"></a><span class="do">#####</span></span>
<span id="cb5-2"><a href="query.html#cb5-2" tabindex="-1"></a><span class="do">##### Dummy / empty polygon, used to avoid crash on start when query incomplete</span></span>
<span id="cb5-3"><a href="query.html#cb5-3" tabindex="-1"></a><span class="do">#####</span></span>
<span id="cb5-4"><a href="query.html#cb5-4" tabindex="-1"></a>dummy_polygon <span class="ot">&lt;-</span> <span class="fu">st_polygon</span>(<span class="fu">list</span>(<span class="fu">rbind</span>(</span>
<span id="cb5-5"><a href="query.html#cb5-5" tabindex="-1"></a>  <span class="fu">c</span>(<span class="sc">-</span><span class="fl">123.0001</span>, <span class="fl">49.0001</span>),  <span class="co"># Top-left</span></span>
<span id="cb5-6"><a href="query.html#cb5-6" tabindex="-1"></a>  <span class="fu">c</span>(<span class="sc">-</span><span class="fl">123.0001</span>, <span class="fl">49.0000</span>),  <span class="co"># Bottom-left</span></span>
<span id="cb5-7"><a href="query.html#cb5-7" tabindex="-1"></a>  <span class="fu">c</span>(<span class="sc">-</span><span class="fl">123.0000</span>, <span class="fl">49.0000</span>),  <span class="co"># Bottom-right</span></span>
<span id="cb5-8"><a href="query.html#cb5-8" tabindex="-1"></a>  <span class="fu">c</span>(<span class="sc">-</span><span class="fl">123.0000</span>, <span class="fl">49.0001</span>),  <span class="co"># Top-right</span></span>
<span id="cb5-9"><a href="query.html#cb5-9" tabindex="-1"></a>  <span class="fu">c</span>(<span class="sc">-</span><span class="fl">123.0001</span>, <span class="fl">49.0001</span>)   <span class="co"># Closing the polygon (back to top-left)</span></span>
<span id="cb5-10"><a href="query.html#cb5-10" tabindex="-1"></a>)))</span>
<span id="cb5-11"><a href="query.html#cb5-11" tabindex="-1"></a><span class="co"># Create an sf object with this geometry</span></span>
<span id="cb5-12"><a href="query.html#cb5-12" tabindex="-1"></a>empty_sf <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(</span>
<span id="cb5-13"><a href="query.html#cb5-13" tabindex="-1"></a>  <span class="at">Bound_North =</span> <span class="fl">49.0001</span>,</span>
<span id="cb5-14"><a href="query.html#cb5-14" tabindex="-1"></a>  <span class="at">Bound_South =</span> <span class="fl">49.0000</span>,</span>
<span id="cb5-15"><a href="query.html#cb5-15" tabindex="-1"></a>  <span class="at">Bound_East =</span> <span class="sc">-</span><span class="fl">123.0000</span>,</span>
<span id="cb5-16"><a href="query.html#cb5-16" tabindex="-1"></a>  <span class="at">Bound_West =</span> <span class="sc">-</span><span class="fl">123.0001</span>,</span>
<span id="cb5-17"><a href="query.html#cb5-17" tabindex="-1"></a>  <span class="at">Centre_Lat =</span> <span class="fl">49.00005</span>,</span>
<span id="cb5-18"><a href="query.html#cb5-18" tabindex="-1"></a>  <span class="at">Centre_Lng =</span> <span class="sc">-</span><span class="fl">123.00005</span>,</span>
<span id="cb5-19"><a href="query.html#cb5-19" tabindex="-1"></a>  <span class="at">Geometry_WKT =</span> <span class="fu">st_sfc</span>(dummy_polygon)</span>
<span id="cb5-20"><a href="query.html#cb5-20" tabindex="-1"></a>)</span>
<span id="cb5-21"><a href="query.html#cb5-21" tabindex="-1"></a></span>
<span id="cb5-22"><a href="query.html#cb5-22" tabindex="-1"></a><span class="do">#####</span></span>
<span id="cb5-23"><a href="query.html#cb5-23" tabindex="-1"></a><span class="do">##### Live updating display polygons</span></span>
<span id="cb5-24"><a href="query.html#cb5-24" tabindex="-1"></a><span class="do">#####</span></span>
<span id="cb5-25"><a href="query.html#cb5-25" tabindex="-1"></a><span class="co">#Generally, it&#39;s better to have the bounds stored in a separate reactive or reactval,</span></span>
<span id="cb5-26"><a href="query.html#cb5-26" tabindex="-1"></a><span class="co">#so you&#39;re not calculating multiple times when filtering multiple datasets</span></span>
<span id="cb5-27"><a href="query.html#cb5-27" tabindex="-1"></a>polygons_to_map <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb5-28"><a href="query.html#cb5-28" tabindex="-1"></a>    bounds <span class="ot">&lt;-</span> input<span class="sc">$</span>mapname_bounds</span>
<span id="cb5-29"><a href="query.html#cb5-29" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(bounds)) {</span>
<span id="cb5-30"><a href="query.html#cb5-30" tabindex="-1"></a>      <span class="fu">return</span>(empty_sf)  <span class="co"># Return empty sf object initially, avoids crash on start</span></span>
<span id="cb5-31"><a href="query.html#cb5-31" tabindex="-1"></a>    }</span>
<span id="cb5-32"><a href="query.html#cb5-32" tabindex="-1"></a>    <span class="fu">some_query_function</span>(...,</span>
<span id="cb5-33"><a href="query.html#cb5-33" tabindex="-1"></a>      <span class="st">&quot;SELECT *&quot;</span>,</span>
<span id="cb5-34"><a href="query.html#cb5-34" tabindex="-1"></a>      <span class="st">&quot;FROM table&quot;</span>,</span>
<span id="cb5-35"><a href="query.html#cb5-35" tabindex="-1"></a>      <span class="fu">bbox_filter</span>(bounds<span class="sc">$</span>south, bounds<span class="sc">$</span>north, bounds<span class="sc">$</span>west, bounds<span class="sc">$</span>east)</span>
<span id="cb5-36"><a href="query.html#cb5-36" tabindex="-1"></a>      <span class="co"># ^ Returns WHERE... AND ... AND ... AND ... statement</span></span>
<span id="cb5-37"><a href="query.html#cb5-37" tabindex="-1"></a>    )</span>
<span id="cb5-38"><a href="query.html#cb5-38" tabindex="-1"></a>  })</span>
<span id="cb5-39"><a href="query.html#cb5-39" tabindex="-1"></a><span class="co">#Update map based on new bounding box / filtering</span></span>
<span id="cb5-40"><a href="query.html#cb5-40" tabindex="-1"></a><span class="fu">observe</span>({</span>
<span id="cb5-41"><a href="query.html#cb5-41" tabindex="-1"></a>    <span class="fu">leafletProxy</span>(<span class="st">&quot;mapname&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-42"><a href="query.html#cb5-42" tabindex="-1"></a>      <span class="fu">clearShapes</span>() <span class="sc">%&gt;%</span> <span class="co">#can clear a group instead to be more precise</span></span>
<span id="cb5-43"><a href="query.html#cb5-43" tabindex="-1"></a>      <span class="fu">addPolygons</span>(<span class="at">data =</span> <span class="fu">polygons_to_map</span>()<span class="sc">$</span>Geometry_WKT, </span>
<span id="cb5-44"><a href="query.html#cb5-44" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">weight =</span> <span class="dv">2</span>, <span class="at">opacity =</span> <span class="fl">0.5</span>, <span class="at">fillOpacity =</span> <span class="fl">0.2</span>)</span>
<span id="cb5-45"><a href="query.html#cb5-45" tabindex="-1"></a>  })</span></code></pre></div>
</div>
<div id="dynamic-filtering-shiny" class="section level4 hasAnchor" number="4.0.1.3">
<h4><span class="header-section-number">4.0.1.3</span> Dynamic Filtering (Shiny)<a href="query.html#dynamic-filtering-shiny" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Method to use the most optimal filter (speed / gaps tradeoff) for different zoom levels. Simply use an if statement taking the zoom as input, selecting a different filter_type.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="query.html#cb6-1" tabindex="-1"></a>pick_polygon_filter_type <span class="ot">&lt;-</span> <span class="cf">function</span>(zoom_level, high_cutoff, mid_cutoff, low_cutoff, off_cutoff){</span>
<span id="cb6-2"><a href="query.html#cb6-2" tabindex="-1"></a>  <span class="cf">if</span> (zoom_level <span class="sc">&gt;=</span> high_cutoff) {</span>
<span id="cb6-3"><a href="query.html#cb6-3" tabindex="-1"></a>    <span class="co"># Use greedy filter at higher zoom levels</span></span>
<span id="cb6-4"><a href="query.html#cb6-4" tabindex="-1"></a>    filter_to_use <span class="ot">&lt;-</span> <span class="st">&quot;greedy&quot;</span></span>
<span id="cb6-5"><a href="query.html#cb6-5" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (zoom_level <span class="sc">&gt;=</span> mid_cutoff) {</span>
<span id="cb6-6"><a href="query.html#cb6-6" tabindex="-1"></a>    filter_to_use <span class="ot">&lt;-</span> <span class="st">&quot;central&quot;</span></span>
<span id="cb6-7"><a href="query.html#cb6-7" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (zoom_level <span class="sc">&gt;=</span> low_cutoff) {</span>
<span id="cb6-8"><a href="query.html#cb6-8" tabindex="-1"></a>    <span class="co"># Use shy filter at lower zoom levels</span></span>
<span id="cb6-9"><a href="query.html#cb6-9" tabindex="-1"></a>    filter_to_use <span class="ot">&lt;-</span> <span class="st">&quot;shy&quot;</span></span>
<span id="cb6-10"><a href="query.html#cb6-10" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (zoom_level <span class="sc">&gt;=</span> off_cutoff) {</span>
<span id="cb6-11"><a href="query.html#cb6-11" tabindex="-1"></a>    <span class="co"># Don&#39;t Query Anything</span></span>
<span id="cb6-12"><a href="query.html#cb6-12" tabindex="-1"></a>    filter_to_use <span class="ot">&lt;-</span> <span class="st">&quot;hide&quot;</span></span>
<span id="cb6-13"><a href="query.html#cb6-13" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb6-14"><a href="query.html#cb6-14" tabindex="-1"></a>    <span class="cn">NULL</span></span>
<span id="cb6-15"><a href="query.html#cb6-15" tabindex="-1"></a>  }</span>
<span id="cb6-16"><a href="query.html#cb6-16" tabindex="-1"></a>  <span class="fu">return</span>(filter_to_use)</span>
<span id="cb6-17"><a href="query.html#cb6-17" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="query.html#cb7-1" tabindex="-1"></a>polygons_to_map <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb7-2"><a href="query.html#cb7-2" tabindex="-1"></a>  zoom_level <span class="ot">&lt;-</span> input<span class="sc">$</span>mapname_zoom</span>
<span id="cb7-3"><a href="query.html#cb7-3" tabindex="-1"></a>  bounds <span class="ot">&lt;-</span> input<span class="sc">$</span>mapname_bounds</span>
<span id="cb7-4"><a href="query.html#cb7-4" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(bounds) <span class="sc">||</span> <span class="fu">is.null</span>(zoom_level)) {</span>
<span id="cb7-5"><a href="query.html#cb7-5" tabindex="-1"></a>    <span class="fu">return</span>(empty_sf)</span>
<span id="cb7-6"><a href="query.html#cb7-6" tabindex="-1"></a>  }</span>
<span id="cb7-7"><a href="query.html#cb7-7" tabindex="-1"></a>  </span>
<span id="cb7-8"><a href="query.html#cb7-8" tabindex="-1"></a>  filter_to_use <span class="ot">&lt;-</span> <span class="fu">pick_polygon_filter_type</span>(zoom_level, <span class="dv">14</span>, <span class="dv">10</span>, <span class="dv">7</span>, <span class="dv">0</span>)</span>
<span id="cb7-9"><a href="query.html#cb7-9" tabindex="-1"></a>  <span class="cf">if</span> (filter_to_use <span class="sc">==</span> <span class="st">&quot;hide&quot;</span>){</span>
<span id="cb7-10"><a href="query.html#cb7-10" tabindex="-1"></a>    <span class="fu">return</span>(empty_sf)</span>
<span id="cb7-11"><a href="query.html#cb7-11" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb7-12"><a href="query.html#cb7-12" tabindex="-1"></a>    <span class="fu">some_query_function</span>(...,</span>
<span id="cb7-13"><a href="query.html#cb7-13" tabindex="-1"></a>      <span class="st">&quot;SELECT *&quot;</span>,</span>
<span id="cb7-14"><a href="query.html#cb7-14" tabindex="-1"></a>      <span class="st">&quot;FROM table&quot;</span>,</span>
<span id="cb7-15"><a href="query.html#cb7-15" tabindex="-1"></a>      <span class="fu">bbox_filter</span>(bounds<span class="sc">$</span>south, bounds<span class="sc">$</span>north, bounds<span class="sc">$</span>west, bounds<span class="sc">$</span>east,</span>
<span id="cb7-16"><a href="query.html#cb7-16" tabindex="-1"></a>                           <span class="at">filter_type =</span> filter_to_use)</span>
<span id="cb7-17"><a href="query.html#cb7-17" tabindex="-1"></a>    )</span>
<span id="cb7-18"><a href="query.html#cb7-18" tabindex="-1"></a>  }</span>
<span id="cb7-19"><a href="query.html#cb7-19" tabindex="-1"></a>})</span></code></pre></div>
</div>
</div>
<div id="engulfing-filter" class="section level3 hasAnchor" number="4.0.2">
<h3><span class="header-section-number">4.0.2</span> Engulfing Filter<a href="query.html#engulfing-filter" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Generates a where condition to find polygons that a given point is within.
* Without Shiny, we can just import all the polygons and use st_within
* With Shiny, using a user click as the input point, it’s faster to first query for polygons within the map view box, since we know the click must have been inside there, so we know only polygons which pass a Greedy filter could possibly “engulf” (our name for the inverse of “within”) the point.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="query.html#cb8-1" tabindex="-1"></a><span class="co"># Find polygons within map view box,</span></span>
<span id="cb8-2"><a href="query.html#cb8-2" tabindex="-1"></a><span class="co">#as in the Leaflet Bounding Box Filters, Shiny Example (above)</span></span>
<span id="cb8-3"><a href="query.html#cb8-3" tabindex="-1"></a></span>
<span id="cb8-4"><a href="query.html#cb8-4" tabindex="-1"></a>find_engulfing_polygons <span class="ot">&lt;-</span> <span class="cf">function</span>(click_lat, click_lng, polygons) {</span>
<span id="cb8-5"><a href="query.html#cb8-5" tabindex="-1"></a>  point <span class="ot">&lt;-</span> <span class="fu">st_sfc</span>(<span class="fu">st_point</span>(<span class="fu">c</span>(lng, lat)), <span class="at">crs =</span> <span class="fu">st_crs</span>(polygons))</span>
<span id="cb8-6"><a href="query.html#cb8-6" tabindex="-1"></a>  polygons_engulfing <span class="ot">&lt;-</span> polygons <span class="sc">%&gt;%</span></span>
<span id="cb8-7"><a href="query.html#cb8-7" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">map_lgl</span>(Geometry_WKT, <span class="sc">~</span> <span class="fu">st_within</span>(point, .x, <span class="at">sparse =</span> <span class="cn">FALSE</span>)))</span>
<span id="cb8-8"><a href="query.html#cb8-8" tabindex="-1"></a>  <span class="fu">return</span>(polygons_engulfing)</span>
<span id="cb8-9"><a href="query.html#cb8-9" tabindex="-1"></a>}  </span></code></pre></div>
<p>Shiny example</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="query.html#cb9-1" tabindex="-1"></a><span class="co"># Find polygons within map view box,</span></span>
<span id="cb9-2"><a href="query.html#cb9-2" tabindex="-1"></a><span class="co">#as in the Leaflet Bounding Box Filters, Shiny Example (above)</span></span>
<span id="cb9-3"><a href="query.html#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="query.html#cb9-4" tabindex="-1"></a><span class="co"># polygons_to_map &lt;- ...</span></span>
<span id="cb9-5"><a href="query.html#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="query.html#cb9-6" tabindex="-1"></a><span class="fu">observeEvent</span>(input<span class="sc">$</span>mapname_click, {</span>
<span id="cb9-7"><a href="query.html#cb9-7" tabindex="-1"></a>  click <span class="ot">&lt;-</span> input<span class="sc">$</span>mapname_click</span>
<span id="cb9-8"><a href="query.html#cb9-8" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(click)) <span class="fu">return</span>()</span>
<span id="cb9-9"><a href="query.html#cb9-9" tabindex="-1"></a>  click_lat <span class="ot">&lt;-</span> click<span class="sc">$</span>lat</span>
<span id="cb9-10"><a href="query.html#cb9-10" tabindex="-1"></a>  click_lng <span class="ot">&lt;-</span> click<span class="sc">$</span>lng</span>
<span id="cb9-11"><a href="query.html#cb9-11" tabindex="-1"></a>  </span>
<span id="cb9-12"><a href="query.html#cb9-12" tabindex="-1"></a>  polygons_engulfing <span class="ot">&lt;-</span> <span class="fu">find_engulfing_polygons</span>(click_lat, click_lng, polygons_to_map)</span>
<span id="cb9-13"><a href="query.html#cb9-13" tabindex="-1"></a>})</span>
<span id="cb9-14"><a href="query.html#cb9-14" tabindex="-1"></a></span>
<span id="cb9-15"><a href="query.html#cb9-15" tabindex="-1"></a><span class="co">#Alternatively, if you have no other use for the polygons_to_map,</span></span>
<span id="cb9-16"><a href="query.html#cb9-16" tabindex="-1"></a><span class="co">#you could put that filter process just above the polygons_engulfing &lt;- ...</span></span></code></pre></div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="sql-prep.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="leaflet-example.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
